<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор стоимости - Reffection</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(79.19% 22.8% at 79.19% 22.8%, #05A6F5 4.21%, #0168C7 26.06%, #034090 44.49%, #01193B 82.21%, #00040D 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .background-blur {
            position: absolute;
            top: 460px;
            left: 0;
            width: 1680px;
            height: 1090px;
            background: #074398;
            filter: blur(300px);
            z-index: 0;
        }

        .calculator-container {
            position: relative;
            width: 1280px;
            height: 817px;
            border-radius: 10px;
            margin: 0 auto;
            z-index: 1;
        }

        .header {
            position: absolute;
            left: 50px;
            top: 40px;
            width: 481px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .header h1 {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 36px;
            line-height: 1.17;
            letter-spacing: -2%;
            color: #FFFFFF;
            margin: 0;
        }

        .header p {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 16px;
            line-height: 1.5;
            letter-spacing: 2%;
            color: #FFFFFF;
            margin: 0;
        }

        .product-section {
            position: absolute;
            left: 50px;
            top: 184px;
            width: 360px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-title {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 14px;
            line-height: 1.57;
            letter-spacing: 2%;
            color: #FFFFFF;
        }

        .product-selector {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 26px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(150px);
            box-shadow: inset 0px 0px 50px 0px rgba(255, 255, 255, 0.2);
            gap: 14px;
            cursor: pointer;
        }

        .product-name {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 18px;
            line-height: 1.44;
            letter-spacing: 2%;
            color: #FFFFFF;
            flex: 1;
        }

        .dropdown-arrow {
            width: 12px;
            height: 6px;
            stroke: #FFFFFF;
            stroke-width: 2px;
            transition: transform 0.3s ease;
        }

        .dropdown-arrow.open {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: radial-gradient(79.19% 22.8% at 79.19% 22.8%, rgba(5, 166, 245, 0.9) 4.21%, rgba(1, 104, 199, 0.9) 26.06%, rgba(3, 64, 144, 0.9) 44.49%, rgba(1, 25, 59, 0.9) 82.21%, rgba(0, 4, 13, 0.9) 100%);
            border: 1px solid #494949;
            border-radius: 20px;
            backdrop-filter: blur(100px);
            z-index: 10;
            margin-top: 8px;
            overflow: hidden;
        }

        .dropdown-item {
            padding: 20px 30px;
            font-family: 'Onest';
            font-weight: 400;
            font-size: 20px;
            line-height: 1.5;
            letter-spacing: 2%;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.selected {
            background: rgba(5, 166, 245, 0.2);
        }

        .average-check-section {
            position: absolute;
            left: 50px;
            top: 332px;
            width: 770px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
            padding: 20px 26px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(150px);
            box-shadow: inset 0px 0px 50px 0px rgba(255, 255, 255, 0.2);
            height: 66px;
        }

        .input-placeholder {
            position: absolute;
            left: 36px;
            top: 30px;
            width: 300px;
            height: 30px;
            font-family: 'Onest';
            font-weight: 400;
            font-size: 20px;
            line-height: 1.5;
            letter-spacing: 2%;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .input-field {
            background: transparent;
            border: none;
            outline: none;
            color: #FFFFFF;
            font-family: 'Onest';
            font-weight: 400;
            font-size: 18px;
            line-height: 1.44;
            letter-spacing: 2%;
            width: 100%;
            padding: 0;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .disclaimer {
            position: absolute;
            left: 870px;
            top: 40px;
            width: 360px;
            height: 66px;
            font-family: 'Onest';
            font-weight: 400;
            font-size: 14px;
            line-height: 1.57;
            letter-spacing: 2%;
            color: #FFFFFF;
        }

        
        .subscription-section {
            position: absolute;
            left: 460px;
            top: 184px;
            width: 360px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .subscription-selector {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 26px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(150px);
            box-shadow: inset 0px 0px 50px 0px rgba(255, 255, 255, 0.2);
            height: 66px;
            cursor: pointer;
        }

        .subscription-value {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 18px;
            line-height: 1.44;
            letter-spacing: 2%;
            color: #FFFFFF;
            flex: 1;
        }

        .subscription-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: radial-gradient(79.19% 22.8% at 79.19% 22.8%, rgba(5, 166, 245, 0.9) 4.21%, rgba(1, 104, 199, 0.9) 26.06%, rgba(3, 64, 144, 0.9) 44.49%, rgba(1, 25, 59, 0.9) 82.21%, rgba(0, 4, 13, 0.9) 100%);
            border: 1px solid #494949;
            border-radius: 20px;
            backdrop-filter: blur(100px);
            z-index: 10;
            margin-top: 8px;
            overflow: hidden;
        }

        .subscription-dropdown-item {
            padding: 20px 30px;
            font-family: 'Onest';
            font-weight: 400;
            font-size: 20px;
            line-height: 1.5;
            letter-spacing: 2%;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .subscription-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .subscription-dropdown-item.selected {
            background: rgba(5, 166, 245, 0.2);
        }

        .contacts-section {
            position: absolute;
            left: 50px;
            top: 520px;
            width: 770px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .contacts-title {
            position: absolute;
            left: 50px;
            top: 480px;
            font-family: 'Onest';
            font-weight: 400;
            font-size: 14px;
            line-height: 1.57;
            letter-spacing: 2%;
            color: #FFFFFF;
        }

        .slider-container {
            position: relative;
            width: 100%;
            height: 60px;
            padding: 20px 0;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .slider-track {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 66px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            transform: translateY(-50%);
            backdrop-filter: blur(100px);
        }

        .slider-track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #00040D 0%, #01193B 17.79%, #034090 55.51%, #0168C7 73.94%, #05A6F5 95.79%);
            border-radius: 20px;
            width: var(--slider-progress, 0%);
            transition: width 0.1s ease;
        }

        .slider-thumb {
            position: absolute;
            top: 50%;
            width: 34px;
            height: 34px;
            background: #FFFFFF;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.4);
            transition: box-shadow 0.2s ease, transform 0.1s ease;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .slider-thumb::before {
            content: url('data:image/svg+xml;utf8,<svg width="4" height="8" viewBox="0 0 4 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 1L1 4L3 7" stroke="%23006AFE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
            display: flex;
            justify-content: center;
            align-items: center;
            width: 4px;
            height: 8px;
            margin-right: 4px;
        }

        .slider-thumb::after {
            content: url('data:image/svg+xml;utf8,<svg width="4" height="8" viewBox="0 0 4 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L3 4L1 7" stroke="%23006AFE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
            display: flex;
            justify-content: center;
            align-items: center;
            width: 4px;
            height: 8px;
            margin-left: 4px;
        }
        
        .slider-thumb:hover {
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        .slider-thumb:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.02);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 0 20px;
        }

        .slider-label {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 18px;
            line-height: 1.44;
            letter-spacing: 2%;
            color: #FFFFFF;
        }

        .slider-value {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Onest';
            font-weight: 600;
            font-size: 16px;
            line-height: 1.5;
            letter-spacing: 2%;
            color: #034090;
            background: #FFFFFF;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            z-index: 4;
            border: none;
        }

        .slider-value::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #FFFFFF;
        }

        .results-card {
            position: absolute;
            left: 870px;
            top: 184px;
            width: 360px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            backdrop-filter: blur(150px);
            padding: 30px;
            box-shadow: inset 0px 0px 50px 0px rgba(255, 255, 255, 0.2);
        }

        .results-header {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 30px;
            line-height: 1.2;
            letter-spacing: -2%;
            color: #FFFFFF;
            margin-bottom: 30px;
            text-align: left;
        }

        .results-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 35px;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        .result-item::before {
            content: '';
            width: 0;
            height: 26px;
            border-left: 6px solid #FFFFFF;
            flex-shrink: 0;
        }

        .result-icon {
            display: none;
        }

        .result-text {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 18px;
            line-height: 1.44;
            letter-spacing: 2%;
            color: #FFFFFF;
        }

        .budget-section {
            background: #FFFFFF;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        


        .budget-label {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 18px;
            line-height: 1.44;
            letter-spacing: 2%;
            color: #121212;
            margin-bottom: 12px;
        }

        .budget-value {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 30px;
            line-height: 1.2;
            letter-spacing: -2%;
            color: #121212;
            text-align: left;
        }

        .submit-button {
            background: #FFFFFF;
            border-radius: 50px;
            border: none;
            padding: 4px 14px 5px;
            width: 100%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .submit-text {
            font-family: 'IBM Plex Mono';
            font-weight: 400;
            font-size: 14px;
            line-height: 1.3;
            letter-spacing: 2%;
            color: #121212;
            text-transform: uppercase;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-family: 'Onest';
            font-weight: 600;
            font-size: 24px;
            color: #000000;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #000000;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .subscription-info h4 {
            font-family: 'Onest';
            font-weight: 600;
            font-size: 18px;
            color: #000000;
            margin: 0 0 10px 0;
        }

        .subscription-info p {
            font-family: 'Onest';
            font-weight: 400;
            font-size: 16px;
            line-height: 24px;
            color: #000000;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="background-blur"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // Configuration and constants
        const CONFIG = {
            SUBSCRIPTIONS: {
                1: "Target_pricing",
                2: "Retargeting pricing",
                3: "Колл-центр"
            },
            
            SERVICE_PRICING: {
                1: [
                    {contacts: 0, price_per_contact: 70},
                    {contacts: 1000, price_per_contact: 60},
                    {contacts: 3000, price_per_contact: 50},
                    {contacts: 4000, price_per_contact: 45},
                    {contacts: 5000, price_per_contact: 43},
                    {contacts: 6000, price_per_contact: 40},
                    {contacts: 7000, price_per_contact: 36},
                    {contacts: 8000, price_per_contact: 34},
                    {contacts: 9000, price_per_contact: 32},
                    {contacts: 10000, price_per_contact: 30},
                    {contacts: 13000, price_per_contact: 29},
                    {contacts: 15000, price_per_contact: 28},
                    {contacts: 20000, price_per_contact: 26},
                    {contacts: 25000, price_per_contact: 25},
                    {contacts: 30000, price_per_contact: 24},
                    {contacts: 35000, price_per_contact: 23},
                    {contacts: 40000, price_per_contact: 22},
                    {contacts: 45000, price_per_contact: 21},
                    {contacts: 50000, price_per_contact: 20}
                ],
                2: [
                    {contacts: 0, price_per_contact: 50},
                    {contacts: 1000, price_per_contact: 45},
                    {contacts: 3000, price_per_contact: 40},
                    {contacts: 4000, price_per_contact: 38},
                    {contacts: 5000, price_per_contact: 36},
                    {contacts: 6000, price_per_contact: 34},
                    {contacts: 7000, price_per_contact: 32},
                    {contacts: 8000, price_per_contact: 30},
                    {contacts: 9000, price_per_contact: 28},
                    {contacts: 10000, price_per_contact: 26},
                    {contacts: 13000, price_per_contact: 25},
                    {contacts: 15000, price_per_contact: 24},
                    {contacts: 20000, price_per_contact: 22},
                    {contacts: 25000, price_per_contact: 21},
                    {contacts: 30000, price_per_contact: 20},
                    {contacts: 35000, price_per_contact: 19},
                    {contacts: 40000, price_per_contact: 18},
                    {contacts: 45000, price_per_contact: 17},
                    {contacts: 50000, price_per_contact: 16}
                ],
                3: [
                    {contacts: 0, price_per_call: 50},
                    {contacts: 1000, price_per_call: 45},
                    {contacts: 3000, price_per_call: 40},
                    {contacts: 4000, price_per_call: 35},
                    {contacts: 5000, price_per_call: 34},
                    {contacts: 6000, price_per_call: 33},
                    {contacts: 7000, price_per_call: 32},
                    {contacts: 8000, price_per_call: 31},
                    {contacts: 9000, price_per_call: 30},
                    {contacts: 10000, price_per_call: 29},
                    {contacts: 13000, price_per_call: 28},
                    {contacts: 15000, price_per_call: 27},
                    {contacts: 20000, price_per_call: 26},
                    {contacts: 25000, price_per_call: 25},
                    {contacts: 30000, price_per_call: 24},
                    {contacts: 35000, price_per_call: 23},
                    {contacts: 40000, price_per_call: 22},
                    {contacts: 45000, price_per_call: 21},
                    {contacts: 50000, price_per_call: 20}
                ]
            },
            
            TECH_PACKAGES: {
                "Стандарт": {"price": 14900, "discount": 0.0},
                "Премиум": {"price": 24900, "discount": 0.05},
                "Бизнес": {"price": 49900, "discount": 0.1},
                "Call": {"price": 4990, "discount": 0.0}
            },
            
            SERVICE_OPTIONS: [
                { id: 1, name: "Segment_scoring" },
                { id: 2, name: "Retargeting Trigger Leads" },
                { id: 3, name: "Reactivation/Validation" }
            ],
            
            SUBSCRIPTION_OPTIONS: [
                { id: "tech", name: "Tech", package: "Стандарт" },
                { id: "must", name: "Must", package: "Премиум" },
                { id: "pro", name: "Pro", package: "Бизнес" },
                { id: "call", name: "Call", package: "Call" }
            ],
            
            SLIDER: {
                MIN: 1000,
                MAX: 50000,
                STEP: 100
            }
        };

        // Business logic functions
        const calculateCostByTiers = (contacts, pricing) => {
            let totalCost = 0;
            let remainingContacts = contacts;
            
            for (let i = 0; i < pricing.length; i++) {
                const tier = pricing[i];
                const nextTier = pricing[i + 1];
                
                const priceField = tier.price_per_contact || tier.price_per_call;
                
                if (nextTier) {
                    const tierContacts = Math.min(remainingContacts, nextTier.contacts - tier.contacts);
                    totalCost += tierContacts * priceField;
                    remainingContacts -= tierContacts;
                    
                    if (remainingContacts <= 0) break;
                } else {
                    totalCost += remainingContacts * priceField;
                    break;
                }
            }
            
            return totalCost;
        };

        const getConversionRate = (averageCheck, serviceType) => {
            let baseRate;
            if (averageCheck < 100000) {
                baseRate = 0.03;
            } else if (averageCheck >= 100000 && averageCheck < 3000000) {
                baseRate = 0.02;
            } else {
                baseRate = 0.005;
            }
            
            if (serviceType === 2) {
                return baseRate * 2;
            } else if (serviceType === 3) {
                return baseRate * 3;
            }
            
            return baseRate;
        };

        const getServicePrice = (serviceType, contacts, techPackage) => {
            const pricing = CONFIG.SERVICE_PRICING[serviceType];
            const totalCost = calculateCostByTiers(contacts, pricing);
            
            let contactProcessingCost = 0;
            const isTechSubscription = techPackage === "Стандарт" && (serviceType === 1 || serviceType === 2);
            if ((serviceType === 1 || serviceType === 2) && !isTechSubscription) {
                contactProcessingCost = calculateCostByTiers(contacts, CONFIG.SERVICE_PRICING[3]);
            }
            
            const totalServiceCost = totalCost + contactProcessingCost;
            const packageInfo = CONFIG.TECH_PACKAGES[techPackage];
            const packageCost = packageInfo.price;
            const discount = packageInfo.discount;
            const discountedServiceCost = totalServiceCost * (1 - discount);
            const totalCostWithPackage = discountedServiceCost + packageCost;
            
            const contactCostWithSubscription = Math.round(totalCostWithPackage / contacts);
            
            return {
                totalCost,
                contactProcessingCost,
                totalServiceCost,
                packageCost,
                discount,
                totalCostWithPackage,
                contactCostWithSubscription
            };
        };
        
        // Custom hooks
        const useCalculator = (serviceType, contacts, averageCheck, techPackage) => {
            const results = useMemo(() => {
                const pricing = getServicePrice(serviceType, contacts, techPackage);
                const conversionRate = getConversionRate(averageCheck, serviceType);
                const expectedConversions = Math.round(contacts * conversionRate);
                const costPerConversion = pricing.totalCostWithPackage / expectedConversions;
                
                return {
                    ...pricing,
                    conversionRate,
                    expectedConversions,
                    costPerConversion,
                    isTechSubscription: techPackage === "Стандарт" && (serviceType === 1 || serviceType === 2)
                };
            }, [serviceType, contacts, averageCheck, techPackage]);
            
            return results;
        };
        
        const useSlider = (initialValue = 4500) => {
            const [value, setValue] = useState(initialValue);
            const [isDragging, setIsDragging] = useState(false);
            
            const handleSliderChange = useCallback((e) => {
                const newValue = parseInt(e.target.value);
                setValue(newValue);
            }, []);
            
            const handleThumbMouseDown = useCallback((e) => {
                e.stopPropagation();
                setIsDragging(true);
            }, []);
            
            const updateSliderValue = useCallback((e) => {
                const slider = e.currentTarget.closest ? e.currentTarget.closest('.slider-container') : e.currentTarget;
                const rect = slider.getBoundingClientRect();
                const percentage = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const newValue = Math.round(CONFIG.SLIDER.MIN + percentage * (CONFIG.SLIDER.MAX - CONFIG.SLIDER.MIN));
                const steppedValue = Math.round(newValue / CONFIG.SLIDER.STEP) * CONFIG.SLIDER.STEP;
                setValue(Math.max(CONFIG.SLIDER.MIN, Math.min(CONFIG.SLIDER.MAX, steppedValue)));
            }, []);
            
            const handleTrackClick = useCallback((e) => {
                updateSliderValue(e);
            }, [updateSliderValue]);
            
            const handleMouseMove = useCallback((e) => {
                if (isDragging) {
                    updateSliderValue(e);
                }
            }, [isDragging, updateSliderValue]);
            
            const handleMouseUp = useCallback(() => {
                setIsDragging(false);
            }, []);
            
            useEffect(() => {
                if (isDragging) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [isDragging, handleMouseMove, handleMouseUp]);
            
            return {
                value,
                setValue,
                isDragging,
                handleSliderChange,
                handleThumbMouseDown,
                handleTrackClick
            };
        };

        // Component functions
        const formatNumber = (num) => {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        };
        
        // Simple prop validation
        const validateProps = (component, props, requiredProps = []) => {
            if (process.env.NODE_ENV !== 'production') {
                requiredProps.forEach(prop => {
                    if (props[prop] === undefined) {
                        console.warn(`${component}: Required prop '${prop}' is missing`);
                    }
                });
            }
        };

        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('Calculator Error:', error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{
                            padding: '20px',
                            background: '#fff',
                            borderRadius: '10px',
                            margin: '20px',
                            textAlign: 'center'
                        }}>
                            <h2>Что-то пошло не так</h2>
                            <p>Произошла ошибка при загрузке калькулятора. Пожалуйста, обновите страницу.</p>
                            <button 
                                onClick={() => window.location.reload()}
                                style={{
                                    padding: '10px 20px',
                                    background: '#007bff',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '5px',
                                    cursor: 'pointer'
                                }}
                            >
                                Обновить страницу
                            </button>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Sub-components
        const ServiceSelector = ({ serviceType, onServiceChange, isDropdownOpen, onToggleDropdown, onInfoClick }) => (
            <div className="product-section">
                <div className="section-title" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                    Выберите продукт
                    <InfoIcon onClick={onInfoClick} />
                </div>
                <div 
                    className="product-selector" 
                    onClick={onToggleDropdown}
                    role="button"
                    tabIndex={0}
                    aria-expanded={isDropdownOpen}
                    aria-haspopup="listbox"
                    onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            onToggleDropdown();
                        }
                    }}
                >
                    <div className="product-name">
                        {CONFIG.SERVICE_OPTIONS.find(option => option.id === serviceType)?.name || "Segment_scoring"}
                    </div>
                    <svg className={`dropdown-arrow ${isDropdownOpen ? 'open' : ''}`} viewBox="0 0 12 6">
                        <path d="M1 1L6 5L11 1" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                </div>
                {isDropdownOpen && (
                    <div className="dropdown-menu" role="listbox">
                        {CONFIG.SERVICE_OPTIONS.map(option => (
                            <div 
                                key={option.id}
                                className={`dropdown-item ${serviceType === option.id ? 'selected' : ''}`}
                                onClick={() => onServiceChange(option.id)}
                                role="option"
                                tabIndex={0}
                                aria-selected={serviceType === option.id}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' || e.key === ' ') {
                                        e.preventDefault();
                                        onServiceChange(option.id);
                                    }
                                }}
                            >
                                {option.name}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        const InfoIcon = ({ onClick }) => (
            <svg 
                className="info-icon" 
                onClick={onClick} 
                viewBox="0 0 16 16" 
                style={{width: '16px', height: '16px', cursor: 'pointer', fill: '#FFFFFF'}}
                role="button"
                tabIndex={0}
                aria-label="Информация о услугах"
                onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        onClick && onClick();
                    }
                }}
            >
                <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
            </svg>
        );

        const AverageCheckInput = ({ averageCheck, onAverageCheckChange }) => (
            <div className="average-check-section">
                <label htmlFor="averageCheck" className="section-title">Средний чек продажи (руб)</label>
                <div className="input-container">
                    <input 
                        id="averageCheck"
                        type="text" 
                        className="input-field"
                        value={averageCheck ? formatNumber(averageCheck) : ''}
                        onChange={(e) => {
                            const value = e.target.value.replace(/\D/g, '');
                            onAverageCheckChange(parseInt(value) || 0);
                        }}
                        placeholder="Введите сумму в рублях |"
                        aria-label="Средний чек продажи в рублях"
                        inputMode="numeric"
                    />
                </div>
            </div>
        );

        const SubscriptionSelector = ({ 
            serviceType, 
            techPackage, 
            onTechPackageChange, 
            isDropdownOpen, 
            onToggleDropdown 
        }) => {
            const getSelectedSubscriptionName = () => {
                const selected = CONFIG.SUBSCRIPTION_OPTIONS.find(option => option.package === techPackage);
                return selected ? selected.name : "Tech";
            };

            return (
                <div className="subscription-section">
                    <div className="section-title">Введите тип подписки</div>
                    <div 
                        className={`subscription-selector ${serviceType === 3 ? 'disabled' : ''}`} 
                        onClick={onToggleDropdown}
                        style={{
                            opacity: serviceType === 3 ? 0.6 : 1,
                            cursor: serviceType === 3 ? 'not-allowed' : 'pointer'
                        }}
                    >
                        <div className="subscription-value">{getSelectedSubscriptionName()}</div>
                        <svg className={`dropdown-arrow ${isDropdownOpen ? 'open' : ''}`} viewBox="0 0 12 6">
                            <path d="M1 1L6 5L11 1" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
                        </svg>
                    </div>
                    {isDropdownOpen && (
                        <div className="subscription-dropdown-menu">
                            {CONFIG.SUBSCRIPTION_OPTIONS
                                .filter(option => {
                                    if (serviceType === 1 || serviceType === 2) {
                                        return option.id !== 'call';
                                    }
                                    return true;
                                })
                                .map(option => (
                                    <div 
                                        key={option.id}
                                        className={`subscription-dropdown-item ${techPackage === option.package ? 'selected' : ''}`}
                                        onClick={() => onTechPackageChange(option.id)}
                                    >
                                        {option.name}
                                    </div>
                                ))
                            }
                        </div>
                    )}
                </div>
            );
        };

        const ContactsSlider = ({ contacts, onContactsChange, isDragging, onThumbMouseDown, onTrackClick }) => (
            <>
                <label htmlFor="contactsSlider" className="contacts-title">Выберите количество контактов</label>
                <div className="contacts-section">
                    <div 
                        className="slider-container"
                        onClick={onTrackClick}
                        style={{ userSelect: 'none' }}
                        role="slider"
                        aria-valuemin={CONFIG.SLIDER.MIN}
                        aria-valuemax={CONFIG.SLIDER.MAX}
                        aria-valuenow={contacts}
                        aria-label={`Количество контактов: ${formatNumber(contacts)}`}
                    >
                        <div 
                            className="slider-track"
                            style={{
                                '--slider-progress': `${((contacts - CONFIG.SLIDER.MIN) / (CONFIG.SLIDER.MAX - CONFIG.SLIDER.MIN)) * 100}%`
                            }}
                        ></div>
                        <input 
                            id="contactsSlider"
                            type="range" 
                            min={CONFIG.SLIDER.MIN}
                            max={CONFIG.SLIDER.MAX}
                            step={CONFIG.SLIDER.STEP}
                            value={contacts}
                            onChange={onContactsChange}
                            aria-label="Выберите количество контактов"
                            style={{
                                position: 'absolute',
                                width: '100%',
                                height: '100%',
                                opacity: 0,
                                cursor: 'pointer',
                                pointerEvents: 'all'
                            }}
                        />
                        <div 
                            className="slider-thumb" 
                            style={{
                                left: `${((contacts - CONFIG.SLIDER.MIN) / (CONFIG.SLIDER.MAX - CONFIG.SLIDER.MIN)) * 100}%`,
                                cursor: isDragging ? 'grabbing' : 'grab'
                            }}
                            onMouseDown={onThumbMouseDown}
                            role="button"
                            tabIndex={-1}
                            aria-hidden="true"
                        ></div>
                        <div 
                            className="slider-value"
                            style={{
                                left: `${((contacts - CONFIG.SLIDER.MIN) / (CONFIG.SLIDER.MAX - CONFIG.SLIDER.MIN)) * 100}%`
                            }}
                            aria-hidden="true"
                        >{formatNumber(contacts)}</div>
                    </div>
                    <div className="slider-labels">
                        <span className="slider-label">1000</span>
                        <span className="slider-label">25 000</span>
                        <span className="slider-label">50 000</span>
                    </div>
                </div>
            </>
        );

        const ResultsCard = ({ results, contacts, serviceType }) => {
            if (!results) return null;

            return (
                <div className="results-card">
                    <div className="results-header">{results.expectedConversions} лида (SQL)</div>
                    
                    <div className="results-list">
                        <div className="result-item">
                            <span className="result-text">Прогноз конверсии: {(results.conversionRate * 100).toFixed(1)}%</span>
                        </div>
                        
                        <div className="result-item">
                            <span className="result-text">
                                {serviceType === 3 ? "Стоимость обработки" : "Стоимость данных"}: {Math.round(results.totalCost / contacts)}₽/ед
                            </span>
                        </div>
                        
                        {(serviceType === 1 || serviceType === 2) && (
                            <div className="result-item">
                                <span className="result-text">
                                    Обработка контакта: {results.isTechSubscription ? "не включено" : `${Math.round(results.contactProcessingCost / contacts)}₽/ед`}
                                </span>
                            </div>
                        )}
                        
                        <div className="result-item">
                            <span className="result-text">Подписка: {formatNumber(results.packageCost)} ₽</span>
                        </div>
                        
                        <div className="result-item">
                            <span className="result-text">Стоимость лида: {formatNumber(results.costPerConversion)} ₽/ед</span>
                        </div>
                    </div>
                    
                    <div className="budget-section">
                        <div className="budget-label">Бюджет:</div>
                        <div className="budget-value">{formatNumber(results.totalCostWithPackage)} ₽</div>
                    </div>
                    
                    <button className="submit-button">
                        <span className="submit-text">ВЫБРАТЬ</span>
                    </button>
                </div>
            );
        };

        const InfoModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Информация о услугах</h3>
                            <button className="modal-close" onClick={onClose}>
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <div className="modal-body">
                            <div className="subscription-info">
                                <h4>Retargeting Trigger Leads</h4>
                                <p>Идентифицирует скрытых посетителей на конкретных страницах сайтов рекламодателя через лёгкий JS-код, фиксирующий geo, источник визита, устройство, время и поведение на страницах. Сопоставляет данные с Big Data Reffection и создаёт уникальный профиль пользователя. Определяет триггеры (поведенческие сигналы), которые показывают, насколько клиент готов к покупке — и возвращает его в воронку продаж.</p>
                            </div>
                            <div className="subscription-info">
                                <h4>Segment Scoring</h4>
                                <p>Собирает данные на сайтах в нише рекламодателя, анализируя цифровой след пользователей через Big Data, DMP Reffection и ML-модели телеком-операторов. Определяет вероятностный уровень вовлечённости и платёжеспособности клиента, учитывая геолокацию, поведение в сети, звонковую активность и контентное потребление.</p>
                            </div>
                            <div className="subscription-info">
                                <h4>Reactivation/Validation</h4>
                                <p>Дозванивается до 90% клиентов, используя технологии обхода спам-фильтров и адаптивную телефонию. Сценарии разговоров адаптированы под вашу нишу — операторы обучены продукту. Фильтрует, квалифицирует и возвращает до 50% потерянных лидов обратно в воронку продаж.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function Calculator() {
            const [serviceType, setServiceType] = useState(1);
            const [averageCheck, setAverageCheck] = useState(100000);
            const [techPackage, setTechPackage] = useState("Стандарт");
            const [isDropdownOpen, setIsDropdownOpen] = useState(false);
            const [isSubscriptionDropdownOpen, setIsSubscriptionDropdownOpen] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            
            // Use custom hooks
            const sliderProps = useSlider(4500);
            const { value: contacts, setValue: setContacts } = sliderProps;
            const results = useCalculator(serviceType, contacts, averageCheck, techPackage);
            
            // Event handlers
            const handleServiceChange = useCallback((serviceId) => {
                setServiceType(serviceId);
                setIsDropdownOpen(false);
                
                if (serviceId === 3) {
                    setTechPackage("Call");
                } else if (serviceId === 1 || serviceId === 2) {
                    if (techPackage === "Call") {
                        setTechPackage("Стандарт");
                    }
                }
            }, [techPackage]);
            
            const handleToggleDropdown = useCallback(() => {
                setIsDropdownOpen(!isDropdownOpen);
            }, [isDropdownOpen]);
            
            const handleSubscriptionDropdownToggle = useCallback(() => {
                if (serviceType === 3) return;
                if (serviceType === 1 || serviceType === 2) {
                    setIsSubscriptionDropdownOpen(!isSubscriptionDropdownOpen);
                }
            }, [serviceType, isSubscriptionDropdownOpen]);
            
            const handleSubscriptionChange = useCallback((subscriptionId) => {
                if (serviceType === 3) {
                    setIsSubscriptionDropdownOpen(false);
                    return;
                }
                
                const selected = CONFIG.SUBSCRIPTION_OPTIONS.find(option => option.id === subscriptionId);
                if (selected && (serviceType === 1 || serviceType === 2) && selected.id !== 'call') {
                    setTechPackage(selected.package);
                }
                setIsSubscriptionDropdownOpen(false);
            }, [serviceType]);
            
            const handleModalToggle = useCallback(() => {
                setIsModalOpen(!isModalOpen);
            }, [isModalOpen]);

            return (
                <div className="calculator-container">
                    <div className="header">
                        <h1>Калькулятор стоимости</h1>
                        <p>Рассчитайте бюджет, охват и конверсию в лиды</p>
                    </div>

                    <div className="disclaimer">
                        *расчет стоимости носит примерный ознакомительный характер. Точный бюджет предоставит ваш персональный менеджер
                    </div>

                    <ServiceSelector 
                        serviceType={serviceType}
                        onServiceChange={handleServiceChange}
                        isDropdownOpen={isDropdownOpen}
                        onToggleDropdown={handleToggleDropdown}
                        onInfoClick={handleModalToggle}
                    />

                    <AverageCheckInput 
                        averageCheck={averageCheck}
                        onAverageCheckChange={setAverageCheck}
                    />

                    <SubscriptionSelector 
                        serviceType={serviceType}
                        techPackage={techPackage}
                        onTechPackageChange={handleSubscriptionChange}
                        isDropdownOpen={isSubscriptionDropdownOpen}
                        onToggleDropdown={handleSubscriptionDropdownToggle}
                    />

                    <ContactsSlider 
                        contacts={contacts}
                        onContactsChange={sliderProps.handleSliderChange}
                        isDragging={sliderProps.isDragging}
                        onThumbMouseDown={sliderProps.handleThumbMouseDown}
                        onTrackClick={sliderProps.handleTrackClick}
                    />

                    <ResultsCard 
                        results={results}
                        contacts={contacts}
                        serviceType={serviceType}
                    />

                    <InfoModal 
                        isOpen={isModalOpen}
                        onClose={handleModalToggle}
                    />
                </div>
            );
        }

        ReactDOM.render(
            <ErrorBoundary>
                <Calculator />
            </ErrorBoundary>, 
            document.getElementById('root')
        );
    </script>
</body>
</html>